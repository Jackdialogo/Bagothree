<script>
    let totalCages = 6; // Static cages (initial)
    let addedCages = []; // To track dynamically added cages with unique IDs

    function goHome() {
        document.getElementById('homePage').style.display = 'block';
        document.getElementById('cageDetails').style.display = 'none';
        document.getElementById('pregnancyOption').style.display = 'none';
        document.getElementById('pregnancyDetails').style.display = 'none';
        document.getElementById('headerTitle').innerHTML = '<strong>RABBIT CAGE</strong>'; // Reset header title
    }

    function showCageDetails(cageNumber) {
        document.getElementById('homePage').style.display = 'none';
        document.getElementById('cageDetails').style.display = 'block';
        loadData(cageNumber);
        document.getElementById('rabbitForm').dataset.cageNumber = cageNumber;
        document.getElementById('headerTitle').innerHTML = `<strong>CAGE ${cageNumber}</strong>`;
    }

    function togglePregnancy(show) {
        document.getElementById('pregnancyOption').style.display = show ? 'block' : 'none';
        document.getElementById('pregnancyDetails').style.display = 'none'; // Hide pregnancy details if gender changes
    }

    function togglePregnancyDetails(show) {
        document.getElementById('pregnancyDetails').style.display = show ? 'block' : 'none';
    }

    function saveData(event) {
        event.preventDefault();
        const form = document.getElementById('rabbitForm');
        const cageNumber = form.dataset.cageNumber;
        const data = new FormData(form);
        const obj = {};
        data.forEach((value, key) => {
            obj[key] = value;
        });
        localStorage.setItem(`rabbitData${cageNumber}`, JSON.stringify(obj));
        alert('Data saved successfully!');
        goToRabbitProfile();
    }

    function loadData(cageNumber) {
        let data = JSON.parse(localStorage.getItem(`rabbitData${cageNumber}`)) || {};
        document.getElementById('serialNumber').value = data.serialNumber || '';
        document.getElementById('breed').value = data.breed || '';
        document.getElementById('family').value = data.family || '';
        document.getElementById('birthDate').value = data.birthDate || '';
        document.getElementById('weight').value = data.weight || '';
        
        if (data.gender === "female") {
            document.querySelector('input[name="gender"][value="female"]').checked = true;
            togglePregnancy(true);
        } else {
            document.querySelector('input[name="gender"][value="male"]').checked = true;
            togglePregnancy(false);
        }

        if (data.pregnant === "yes") {
            document.querySelector('input[name="pregnant"][value="yes"]').checked = true;
            togglePregnancyDetails(true);
        } else {
            document.querySelector('input[name="pregnant"][value="no"]').checked = true;
            togglePregnancyDetails(false);
        }

        document.getElementById('matedRabbit').value = data.matedRabbit || '';
        document.getElementById('pregnancyStart').value = data.pregnancyStart || '';
        document.getElementById('dueDate').value = data.dueDate || '';
        document.querySelector(`input[name="foodIntake"][value="${data.foodIntake || 'normal'}"]`).checked = true;
        document.querySelector(`input[name="mating"][value="${data.mating || 'no'}"]`).checked = true;
        document.getElementById('note').value = data.note || '';
    }

    function goToRabbitProfile() {
        const cageNumber = document.getElementById('rabbitForm').dataset.cageNumber || 1;
        const form = document.getElementById('rabbitForm');
        const data = new FormData(form);
        const params = new URLSearchParams();
        data.forEach((value, key) => {
            params.append(key, value);
        });
        window.location.href = `rabbitinfo.html?cage=${cageNumber}&${params.toString()}`;
    }

    // Enhanced deleteCage function to correctly delete a specific cage
    function deleteCage() {
        const cageNumber = document.getElementById('rabbitForm').dataset.cageNumber;
        if (confirm(`Are you sure you want to delete Cage ${cageNumber}?`)) {
            // Remove cage data from localStorage
            localStorage.removeItem(`rabbitData${cageNumber}`);

            // Check if it's a dynamically added cage
            const cageIndex = addedCages.findIndex(cage => cage === parseInt(cageNumber));
            if (cageIndex !== -1) {
                // Remove the corresponding button from the homePage
                const homePage = document.getElementById('homePage');
                const cageButton = homePage.querySelector(`button[data-cage="${cageNumber}"]`);
                homePage.removeChild(cageButton);

                // Remove from addedCages array
                addedCages.splice(cageIndex, 1);
            }

            alert(`Cage ${cageNumber} has been deleted.`);
            goHome();
        }
    }

    // Enhanced addNewCage function to correctly track and add cages
    function addNewCage() {
        totalCages++;
        addedCages.push(totalCages); // Track new cages

        const homePage = document.getElementById('homePage');
        const newCageButton = document.createElement('button');
        newCageButton.textContent = `CAGE ${totalCages}`;
        newCageButton.setAttribute('data-cage', totalCages); // Set unique cage data attribute
        newCageButton.onclick = () => showCageDetails(totalCages);

        // Insert new cage button before the last button (ADD NEW CAGE)
        homePage.insertBefore(newCageButton, homePage.lastElementChild);
    }

    window.onload = function () {
        let cageNumber = new URLSearchParams(window.location.search).get('cage');
        if (cageNumber) {
            showCageDetails(cageNumber);
        } else {
            goHome();
        }
    }
</script>
